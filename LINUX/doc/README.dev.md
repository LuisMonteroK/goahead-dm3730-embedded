开发人员说明 {#dev}
==========
本项目是web服务器的后端程序.与前端www目录共同使用.用户终端的维护.
git可以查看版本历史.

基于 goahead2.5.0 服务器开发+文件上传补丁.

###开发版本文档

####Makefile项目简介:

`default`:生成host i386体系上的webs软件,可以方便使用如gdb insight之类的调试器调试.目前因为链接了arm版本的库（sys_utl.so等）不再可以编译成为host版本.

`all`:生成target版本webs.

`debug`:同default

`clean`:清理 `*.o` 和生成的 `webs`

`distclean`:在 `clean` 基础上清理文档目录 `html`

`doc`:开发文档

对于文档生成,需要 `doxygen` 软件(版本1.8.1以上).  

和`Graphviz dot`软件用于生成联系图. 

如果有以上软件,发布版也可以通过 `make doc` 生成详细的文档.`make doc-simple`是用于生成精简的文档.生成的文档使用不依赖除浏览器外的任何软件.

####其他脚本

`publish.sh` 生成发布包

`makeversion.sh` 生成`version.h` 版本信息头文件,需要`git`

`chkcode.sh`运行程序并进行详细的内存检查,需要`valgrind`.只能在host平台使用.


###交互

####与客户端

与客户端重度使用 POST 方法传递,前端重度使用 jQuery 的 ajax 与后端交互.

接收客户端发来的数据主要

1. 使用 goahead 自身的 websGetVar 函数解析字符串.如接收系统参数,表计参数这些.
2. 直接就是纯字符串.如日志文件,监视端口配置文件这些.

形如 `name1=value&name2=value2` .

发送给客户端的数据方式:

1. (推荐)JSON.如系统参数的发送.
2. (按需求)直接字符串.如日志文件,监视端口配置文件之类.
3. (不推荐)html格式的字符串.此方法不利用数据/样式/行为分离。尽量避免！

数据格式参考:[JSON数据格式示例](@ref json-date-example)

####与其他程序

与其他程序（例如主程序）主要通过读/写指定的文件实现。

* 修改配置:配置文件(/mnt/nor/conf/*)
* 修改参数:参数文件(/mnt/nor/para/*)
* 读取电量数据:数据文件(/mnt/nond/*).

效率低.但是实现简单.相对移植较为方便,耦合较低.

###webs服务器配置项

在配置文件 `/mnt/nor/conf/goahead.conf` 中给出(其中有较多注释):
* wwwroot 指示www前端网页的根目录
* port 服务器端口,默认为80,使用默认端口浏览器地址栏中可以省略端口号.非root用于*不能*打开/使用1024以下端口.调试时要注意
* errlog 错误日志文件,若没有这一项则会生成 `backup-goahead.log` 备用日志
* confdir conf配置文件目录,默认是`/mnt/nor/conf`.包含一些主程序(抄表程序)需要的规约配置文件和监视端口显示名字文件(通过编辑该文件可以修改监视参数端口显示ETH1/COM1/485-1等).
* paradir para参数文件目录,默认是`/mnt/nor/para`.包含终端系统参数/表计参数/储存周期等一些参数文件.

###配置文件

配置文件一般位于终端 `/mnt/nor/conf` 目录下.其中 `/mnt/nor/conf/goahead.conf` 为后端服务器程序默认的配置文件.该路径由 `conf.h` 硬编码.此配置文件中包含指示前端根目录的项 `wwwroot` .

其他配置文件一般以特定的二进制格式保存.格式参考主程序软代码或 `goahead/doc` 目录下的文档.

配置文件目录抽象成为一个数据库,各个文件抽象成表.所有配置文件操作均参考数据库操作思想实现.

系统参数可以影响其他相关参数的"增" "删"."查"功能仅实现对索引的简单编译.业务需要较为复杂的"查询"功能."改"功能实现.配合简单的"查询"可以满足基本要求.TODO:以数据为底层实现.

###参数文件

参数文件一般位于终端 `mnt/nor/para` 目录下.与抄表/菜单等应用程序共用/交互.

参数文件主要在初始化中读取.然后驻留内存随时需要使用.参数的"再初始化"功能在没有配合终端重启的情况下意义不大.会引起二义性,即客户浏览器显示已经修改,但是终端"采样程序"和"菜单"程序并没有同步"再初始化".所以只有这两个程序都重启后,参数的显示和设置才变得有意义.

配置文件格式参考:

* [系统参数](@ref sys_format)
* [表计参数](@ref mtr_format)
* [监视参数](@ref mon_format)
* [网口参数](@ref net_format)
* [串口参数](@ref sio_format)

###数据文件

数据文件格式参考:

* [历史电量数据](@ref tou_format)

数据的读取(写数据是不符合逻辑的)主要以读取指定的数据文件实现.数据文件是由抄表主程序保存生成的.格式参考主程序源代码或 `/doc` 下文档.应以主程序为准.

数据读取仿照主站采集的思路实现.可以看成一个极简的主站实现.目前只要是实现历史数据的手动上招.因为本服务器目前的使用对象主要针对安装维护人员.所以数据部分实现从简.

